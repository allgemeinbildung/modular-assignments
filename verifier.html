<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Abgabe Überprüfen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 2em; background-color: #f8f9fa; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1, h2, h3, h4 { border-bottom: 1px solid #dee2e6; padding-bottom: 0.5em; color: #343a40; }
        h1 { font-size: 2em; }
        h2 { font-size: 1.7em; background-color: #e9ecef; padding: 0.5em; margin-top: 2em; border-radius: 4px; }
        h3 { font-size: 1.4em; margin-top: 1.5em; border-left: 4px solid #007bff; padding-left: 10px;}
        h4 { font-size: 1.2em; }
        .answer-block, .questions-block, .attachments-block { margin-top: 1em; padding-left: 15px; }
        .answer-content { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; margin-top: 8px; background-color: #fff; }
        .answer-content img { max-width: 100%; height: auto; border: 1px solid #ddd; padding: 3px; border-radius: 4px; }
        .attachment-list { list-style: none; padding: 0; }
        .attachment-list li { margin-bottom: 0.5em; }
        .attachment-list a { display: inline-block; padding: 5px 10px; background-color: #007bff; color: white; text-decoration: none; border-radius: 3px; }
        .attachment-list a:hover { background-color: #0056b3; }
        #results { display: none; margin-top: 2em; }
        pre { background-color: #f1f1f1; padding: 1em; border: 1px solid #ddd; white-space: pre-wrap; word-wrap: break-word; border-radius: 4px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Abgabe Überprüfen</h1>
    <p>Bitte wähle die <code>submission-{name}-{timestamp}.json</code> Datei aus, die der Schüler abgegeben hat.</p>
    <input type="file" id="json-file-input" accept=".json">

    <div id="results">
        <h2>Informationen zur Abgabe</h2>
        <div id="submission-info"></div>

        <div id="rendered-content"></div>

        <h3>Rohdaten der Abgabe</h3>
        <details>
            <summary>Klicken, um die vollständige JSON-Datei anzuzeigen</summary>
            <pre><code id="json-output"></code></pre>
        </details>
    </div>
</div>

<script>
    document.getElementById('json-file-input').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);

                // Display submission info
                document.getElementById('submission-info').innerHTML = `
                    <p><strong>Schüler:</strong> ${data.identifier || 'Unbekannt'}</p>
                    <p><strong>Abgabedatum:</strong> ${new Date(data.createdAt).toLocaleString('de-CH')}</p>
                `;

                // Display the raw JSON for debugging
                document.getElementById('json-output').textContent = JSON.stringify(data, null, 2);
                
                // Render the payload
                renderPayload(data.payload);

                // Show the results section
                document.getElementById('results').style.display = 'block';
            } catch (error) {
                alert('Fehler: Die ausgewählte Datei ist keine gültige JSON-Datei oder hat eine unerwartete Struktur.\n' + error);
                console.error(error);
            }
        };
        reader.readAsText(file);
    });

    /**
     * Renders the main payload of the submission file.
     * @param {object} payload The payload object from the JSON file.
     */
    function renderPayload(payload) {
        const container = document.getElementById('rendered-content');
        container.innerHTML = '';

        // Loop through each main assignment (e.g., "3.4-migration")
        for (const assignmentId in payload) {
            const assignmentData = payload[assignmentId];
            
            const assignmentDiv = document.createElement('div');
            assignmentDiv.innerHTML = `<h2>${assignmentId.replace(/-/g, ' ')}</h2>`;

            // Loop through each sub-assignment (e.g., "Migrationsgruende-Push-Pull-Faktoren")
            for (const subId in assignmentData) {
                const subData = assignmentData[subId];

                const subDiv = document.createElement('div');
                subDiv.className = 'sub-assignment';
                subDiv.innerHTML = `<h3>${subData.title}</h3>`;

                // Render questions if they exist
                if (subData.questions && Object.keys(subData.questions).length > 0) {
                    let questionsHtml = '<div class="questions-block"><h4>Fragen:</h4><ol>';
                    for (const qKey in subData.questions) {
                        questionsHtml += `<li>${subData.questions[qKey]}</li>`;
                    }
                    questionsHtml += '</ol></div>';
                    subDiv.innerHTML += questionsHtml;
                }

                // Render the answer if it exists
                if (subData.answer) {
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'answer-block';
                    answerDiv.innerHTML = '<h4>Antwort:</h4>';
                    
                    const answerContent = document.createElement('div');
                    answerContent.className = 'answer-content';

                    try {
                        // Check if the answer is a JSON string (from a quiz)
                        const quizResult = JSON.parse(subData.answer);
                        answerContent.textContent = `Quiz Ergebnis: ${quizResult.score} / ${quizResult.total}`;
                    } catch (e) {
                        // Otherwise, treat it as HTML (from Quill)
                        answerContent.innerHTML = subData.answer;
                    }
                    answerDiv.appendChild(answerContent);
                    subDiv.appendChild(answerDiv);
                }

                // Render attachments if they exist
                if (subData.attachments && subData.attachments.length > 0) {
                    let attachmentsHtml = '<div class="attachments-block"><h4>Anhänge:</h4><ul class="attachment-list">';
                    subData.attachments.forEach(att => {
                        attachmentsHtml += `<li><a href="${att.data}" download="${att.fileName}">${att.fileName}</a></li>`;
                    });
                    attachmentsHtml += '</ul></div>';
                    subDiv.innerHTML += attachmentsHtml;
                }
                
                assignmentDiv.appendChild(subDiv);
            }
            container.appendChild(assignmentDiv);
        }
    }
</script>
</div>
</body>
</html>